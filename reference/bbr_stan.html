<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Stan models in bbr — bbr_stan • bbr.bayes</title><!-- favicons --><link rel="icon" type="image/png" sizes="48x48" href="../favicon-48x48.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Stan models in bbr — bbr_stan"><meta property="og:description" content='This page provides an overview of the basic structure of Stan models in
bbr. The main entry point for interacting with Stan models is the
bbi_stan_model object. With it, you can create a new model on disk from
"scaffold" files, copy a new model from an existing one, jump to model files
of interest, and submit models. The Details section contains information
about the model structure and the necessary files that will exist on disk for
any bbi_stan_model.'><meta property="og:image" content="https://metrumresearchgroup.github.io/bbr.bayes/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-reference-topic">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bbr.bayes</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/getting-started-nmbayes.html">Getting Started with bbr.bayes and NONMEM Bayes</a>
    </li>
    <li>
      <a href="../articles/getting-started-stan.html">Getting Started with bbr.bayes and Stan</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/metrumresearchgroup/bbr.bayes" class="external-link">
    <span class="fa fa-github fa-lg"></span>

  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Stan models in <code>bbr</code></h1>
    <small class="dont-index">Source: <a href="https://github.com/metrumresearchgroup/bbr.bayes/blob/HEAD/R/bbr-stan.R" class="external-link"><code>R/bbr-stan.R</code></a></small>
    <div class="hidden name"><code>bbr_stan.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This page provides an overview of the basic structure of Stan models in
<code>bbr</code>. The main entry point for interacting with Stan models is the
<code>bbi_stan_model</code> object. With it, you can create a new model on disk from
"scaffold" files, copy a new model from an existing one, jump to model files
of interest, and submit models. The Details section contains information
about the model structure and the necessary files that will exist on disk for
any <code>bbi_stan_model</code>.</p>
    </div>


    <div id="details">
    <h2>Details</h2>

<div class="section">
<h3 id="model-structure">Model Structure<a class="anchor" aria-label="anchor" href="#model-structure"></a></h3>


<p><strong><code>&lt;run&gt;</code></strong> - The "run" is, in some sense, the "name" of a given model.
Practically, it will correspond to the model directory name, the base name of
the bbr-created YAML (<code>&lt;run&gt;.yaml</code>), as well as the base name for some files
in that directory. Calling <code><a href="https://metrumresearchgroup.github.io/bbr/reference/get_model_id.html" class="external-link">bbr::get_model_id()</a></code> on a model object will
return <code>&lt;run&gt;</code> as a string. The <code>bbi_log_df</code> tibbles also all contain a run
column which is populated by calling <code>basename(.mod$absolute_model_path)</code> for
each model. Note: this is <em>not</em> actually stored in the model object because
it can be unequivocally extracted as just described.</p>
<p><strong><code>absolute_model_path</code></strong> - Like the <code>bbi_nonmem_model</code> object, the
<code>bbi_stan_model</code> object will carry around only an absolute path to the model
directory. This will point to the model directory (named <code>&lt;run&gt;</code>) containing
all of the files described below, as well as a <code>&lt;run&gt;.yaml</code> file that <code>bbr</code>
uses to persist model metadata. A model is loaded or created by passing a
relative path to this directory to either <code><a href="https://metrumresearchgroup.github.io/bbr/reference/read_model.html" class="external-link">bbr::read_model()</a></code> or
<code><a href="https://metrumresearchgroup.github.io/bbr/reference/new_model.html" class="external-link">bbr::new_model()</a></code>, both of which return the <code>bbi_stan_model</code> object. When
this object is created, it checks the model directory for the relevant files
and populates <code>absolute_model_path</code>.</p>
</div>

<div class="section">
<h3 id="necessary-files">Necessary Files<a class="anchor" aria-label="anchor" href="#necessary-files"></a></h3>


<p>All of the files described below will exist inside the model directory named
<code>&lt;run&gt;</code>. If you call <code>new_model(..., .model_type = "stan")</code> without any of
these files, template "scaffold" files for all of them will be created in the
newly created model directory.</p>
<p><strong><code>&lt;run&gt;.stan</code></strong> - The Stan file.</p>
<p><strong><code>&lt;run&gt;-stanargs.R</code></strong> - Contains a named list with all of the arguments that
will be passed through to the <a href="https://mc-stan.org/cmdstanr/reference/model-method-sample.html" class="external-link">$sample()</a>
method of <a href="https://mc-stan.org/cmdstanr/reference/CmdStanModel.html" class="external-link">cmdstanr::CmdStanModel</a>. See <code><a href="stanargs.html">set_stanargs()</a></code> for details on
modifying.</p>
<p><strong><code>&lt;run&gt;-standata.R</code></strong> - Contains all necessary R code to read in
any source data and transform them to a Stan-ready data object (list).</p><ul><li><p>Contains only one function, called <code>make_standata(.dir)</code>, that takes a
single argument and returns the data list to pass to the
<a href="https://mc-stan.org/cmdstanr/reference/model-method-sample.html" class="external-link">CmdStanModel$sample()</a>.</p></li>
<li><p>The <code>.dir</code> argument will be the directory containing the script. This is
used to find data files for loading, for example
<code>read_csv(file.path(.dir, "..", "..", "data", "derived", "my_data.csv"))</code></p></li>
<li><p>Can be called (by <code><a href="build_data.html">build_data()</a></code>) to generate the data for model
submission or to compare the resulting data to previously saved data on
disk.</p></li>
<li><p>Note that <code>make_standata</code> will be evaluated in the parent environment of
your global session, giving it access to all other environments on your
search path. This means that you don't <em>need</em> to prefix function calls
with the package name (e.g., <code><a href="https://here.r-lib.org/reference/here.html" class="external-link">here::here()</a></code>), but doing so is recommended
so that <code>make_standata</code> doesn't depend on your search path state. As an
exception, you may be comfortable leaving base packages unqualified
(e.g., <code><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm()</a></code> rather than <code><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">stats::rnorm()</a></code>) because users are unlikely
to remove <code>package:stats</code> from their search path or to attach a package
that overrides <code><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm()</a></code>.</p></li>
</ul><p><strong><code>&lt;run&gt;-init.R</code></strong> - This file contains all necessary R code to create the
initial values passed to the cmdstanr's
<a href="https://mc-stan.org/cmdstanr/reference/model-method-sample.html" class="external-link">$sample()</a> method. This file is a lot like
<code>&lt;run&gt;-standata.R</code> (discussed above) and a scaffold can be created with
<code><a href="add_file_to_model_dir.html">add_staninit_file()</a></code>.</p><ul><li><p>Contains only one function, called <code>make_init(.data)</code>, that takes a
single argument and returns something that can be passed to the <code>init</code>
argument of <code>$sample()</code>. There are several options; see the
<a href="https://mc-stan.org/cmdstanr/reference/model-method-sample.html" class="external-link">$sample()</a> documentation for details.</p></li>
<li><p>The object returned from <code>make_standata()</code> will be passed to the <code>.data</code>
argument of <code>make_init()</code>.</p></li>
<li><p>Will be called internally by <code>bbr</code> and the result passed as the <code>init</code>
argument to <code>$sample()</code>.</p></li>
<li><p>See the <code>make_standata</code> entry above for details on the evaluation
environment.</p></li>
<li><p>Note that <code>$sample()</code> supports passing
<em>"A function that returns a single list..."</em>. If you intend to use this
option, your <code>make_init()</code> function must return <em>the function</em> described,
<em>not</em> the "single list...".</p></li>
<li><p>Note that this file will not be included when you're defining a model for
<em>standalone</em> generated quantities. See "Standalone Generated Quantities"
section below for more information.</p></li>
</ul></div>

<div class="section">
<h3 id="other-files-and-directories">Other Files and Directories<a class="anchor" aria-label="anchor" href="#other-files-and-directories"></a></h3>


<p>There will be several other things created in the model directory, as the
model is run or as it prepares to run.</p>
<p><strong><code>&lt;run&gt;</code></strong> - This is the binary file created when the <code>&lt;run&gt;.stan</code> file is
compiled by <code>cmdstan</code>. We <code>.gitignore</code> this automatically.</p>
<p><strong><code>&lt;run&gt;-output</code></strong> - This directory is created by <code>bbr</code>. It is where the
posteriors will be saved (currently as CSV’s) and also where the
<code>bbi_config.json</code> is saved when the model run finishes successfully. Note
that we <em>don’t</em> call this <code>&lt;run&gt;</code> (as is done in NONMEM) for two primary
reasons:</p><ul><li><p>It is more informative to call it <code>&lt;run&gt;-output</code> to distinguish it from
all the other files and directories that start with <code>&lt;run&gt;</code>.</p></li>
<li><p>There is also the binary called <code>&lt;run&gt;</code> (previously mentioned) that could
cause confusion. In fact, there was a bug in <code>cmdstanr</code> in February 2021
involving exactly this scenario.</p></li>
</ul><p><code>&lt;run&gt;-output/bbi_config.json</code> - This file is created by <code>bbr</code> when a model
run finishes successfully. It stores some configuration information about the
run, as well as the md5 hashes of the necessary files. These hashes are later
used (by <code><a href="https://metrumresearchgroup.github.io/bbr/reference/check_up_to_date.html" class="external-link">bbr::check_up_to_date()</a></code> to check whether the files have changed
since the model was run, primarily for reproducibility purposes.</p>
</div>

<div class="section">
<h3 id="some-helper-functions">Some Helper Functions<a class="anchor" aria-label="anchor" href="#some-helper-functions"></a></h3>

<ul><li><p><strong><code><a href="check_stan_model.html">check_stan_model()</a></code></strong> (mentioned above) - Checks for the necessary files
before running or copying the model. By default, it also checks the syntax
of the <code>&lt;run&gt;.stan</code> file.</p></li>
<li><p><strong><code><a href="https://metrumresearchgroup.github.io/bbr/reference/build_path_from_model.html" class="external-link">bbr::build_path_from_model()</a></code></strong> - Builds the absolute path to a file in
the model folder from a model object and a suffix.</p></li>
<li><p><strong><code><a href="add_file_to_model_dir.html">add_stanmod_file()</a></code>, <code><a href="add_file_to_model_dir.html">add_standata_file()</a></code>, <code><a href="add_file_to_model_dir.html">add_staninit_file()</a></code>,
<code><a href="add_file_to_model_dir.html">add_stan_fitted_params_file()</a></code></strong> - Helpers for adding one of the necessary
files to the model folder.</p></li>
<li><p><strong><code><a href="open_stan_file.html">open_stanmod_file()</a></code>, <code><a href="open_stan_file.html">open_standata_file()</a></code>, <code><a href="open_stan_file.html">open_staninit_file()</a></code>,
<code><a href="open_stan_file.html">open_stan_fitted_params_file()</a></code></strong> - Helpers for opening files within the
model directory.</p></li>
<li><p><strong><code><a href="https://metrumresearchgroup.github.io/bbr/reference/model_diff.html" class="external-link">bbr::model_diff()</a></code></strong> - Compare necessary files between two models.
Defaults to comparing <code>&lt;run&gt;.stan</code> files.</p></li>
<li><p>Also has many of the same helpers as <code>bbi_nonmem_model</code> objects:
<code><a href="https://metrumresearchgroup.github.io/bbr/reference/tags_diff.html" class="external-link">bbr::tags_diff()</a></code>, <code><a href="https://metrumresearchgroup.github.io/bbr/reference/modify_tags.html" class="external-link">bbr::add_tags()</a></code>, <code><a href="https://metrumresearchgroup.github.io/bbr/reference/modify_notes.html" class="external-link">bbr::add_notes()</a></code>,
<code><a href="https://metrumresearchgroup.github.io/bbr/reference/get_path_from_object.html" class="external-link">bbr::get_model_path()</a></code>, <code><a href="https://metrumresearchgroup.github.io/bbr/reference/get_path_from_object.html" class="external-link">bbr::get_output_dir()</a></code>, <code><a href="https://metrumresearchgroup.github.io/bbr/reference/get_model_id.html" class="external-link">bbr::get_model_id()</a></code></p></li>
</ul></div>

<div class="section">
<h3 id="standalone-generated-quantities">Standalone Generated Quantities<a class="anchor" aria-label="anchor" href="#standalone-generated-quantities"></a></h3>


<p>Stan supports generating quantities of interest from existing posterior
samples (see <a href="https://mc-stan.org/docs/stan-users-guide/stand-alone-generated-quantities-and-ongoing-prediction.html" class="external-link">Stan user's guide</a>).
<span class="pkg">cmdstanr</span> exposes this through the
<a href="https://mc-stan.org/cmdstanr/reference/model-method-generate-quantities.html" class="external-link">$generate_quantities()</a> of
<a href="https://mc-stan.org/cmdstanr/reference/CmdStanModel.html" class="external-link">cmdstanr::CmdStanModel</a>.</p>
<p><em>Note:</em> The information below applies to <em>standalone</em> generated quantities.
If the model defines generated quantities that are produced at the same time
as the MCMC samples, the model will have the structure defined above.</p>
<p>In <code>bbr</code>, models for standalone generated quantities are defined via the
<code>bbi_stan_gq_model</code> object, a subclass of <code>bbi_stan_model</code>. On the file
system, these models look very similar to regular Stan models, with the
following differences:</p><ul><li><p>the "model_type" value in the model YAML is "stan_gq" instead of "stan"</p></li>
<li><p>there is no <code>&lt;run&gt;-init.R</code> file;
<a href="https://mc-stan.org/cmdstanr/reference/model-method-generate-quantities.html" class="external-link">$generate_quantities()</a> does
not have an <code>init</code> argument.</p></li>
<li><p>there is a <code>&lt;run&gt;-fitted-params.R</code> file. This file must define a function,
<code>make_fitted_params</code>, that takes a single argument, the model object. The
function can return any value accepted for the <code>fitted_params</code> argument of
<a href="https://mc-stan.org/cmdstanr/reference/model-method-generate-quantities.html" class="external-link">$generate_quantities()</a>.</p>
<p>See the <code>make_standata</code> entry above for details on the evaluation
environment.</p></li>
</ul><p>"stan_gq" models can be created fresh with <code>new_model(..., .model_type = "stan_gq")</code>. However, for the more common case where the "stan_gq" model is
derived from an existing "stan" model, you can use the
<code><a href="copy_model_as_stan_gq.html">copy_model_as_stan_gq()</a></code> helper, which takes care of copying over the
relevant files, adding a "gq_parent" field to the model's YAML file that
points back to the parent model, and setting up a default
<code>&lt;run&gt;-fitted-params.R</code> that returns the paths to the parent model's
posteriors.</p>
<p>The "gq_parent" field of "stan_gq" models links to the "stan" model whose
samples are used as input. The default <code>&lt;run&gt;-fitted-params.R</code> uses this
value to retrieve the previous fit, and
<a href="check_up_to_date_stan_model.html">check_up_to_date</a> considers it when deciding
whether a model is up to date.</p>
<p>In the most common case, the "gq_parent" value will be automatically set up
by <code><a href="copy_model_as_stan_gq.html">copy_model_as_stan_gq()</a></code>. However, you may want to manually set this to
multiple values (e.g., with <code><a href="modify_stan_gq_parent.html">add_stan_gq_parent()</a></code>) for cases where the
fitted parameters are coming from multiple models. The field may also be
absent, which is appropriate for cases where the fitted parameters are not
coming from a previous model.</p>
<p>To run a "stan_gq" model, pass the <code>bbi_stan_gq_model</code> object to
<a href="stan_submit_model.html">submit_model()</a>, which will use the model files to
construct a call to
<a href="https://mc-stan.org/cmdstanr/reference/model-method-generate-quantities.html" class="external-link">CmdStanModel$generate_quantities()</a>.</p>
</div>

    </div>

  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Seth Green, Kyle Meyer, Tim Waterhouse, Jonathan French, Kyle T Baron.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

      </footer></div>






  </body></html>

