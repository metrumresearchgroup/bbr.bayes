<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Join Bayesian model output summaries to input data — nm_join_bayes • bbr.bayes</title><!-- favicons --><link rel="icon" type="image/png" sizes="48x48" href="../favicon-48x48.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Join Bayesian model output summaries to input data — nm_join_bayes"><meta property="og:description" content="nm_join_bayes() and nm_join_bayes_quick() both join model output
summaries to the input data. Underneath this calls bbr::nm_join() on each
chain submodel and then combines the results, summarizing the table values
across chains.
By default nm_join_bayes() replaces some table quantities with summaries of
simulated values. It selects a subset of posterior samples and simulates
EPRED and IPRED with specified mrgsolve model. It also feeds the
simulated EPRED values to npde to calculate EWRES and NPDE values.
nm_join_bayes_quick(), on the other hand, avoids the simulation; the
reported values are calculated from the table values. Warning: these
estimates should not be considered as reliable but may be useful in the early
stages of model development."><meta property="og:image" content="https://metrumresearchgroup.github.io/bbr.bayes/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-reference-topic">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bbr.bayes</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/getting-started-nmbayes.html">Getting Started with bbr.bayes and NONMEM Bayes</a>
    </li>
    <li>
      <a href="../articles/getting-started-stan.html">Getting Started with bbr.bayes and Stan</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/metrumresearchgroup/bbr.bayes" class="external-link">
    <span class="fa fa-github fa-lg"></span>

  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Join Bayesian model output summaries to input data</h1>
    <small class="dont-index">Source: <a href="https://github.com/metrumresearchgroup/bbr.bayes/blob/HEAD/R/nm-join-bayes.R" class="external-link"><code>R/nm-join-bayes.R</code></a></small>
    <div class="hidden name"><code>nm_join_bayes.Rd</code></div>
    </div>

    <div class="ref-description">
    <p><code>nm_join_bayes()</code> and <code>nm_join_bayes_quick()</code> both join model output
summaries to the input data. Underneath this calls <code><a href="https://metrumresearchgroup.github.io/bbr/reference/nm_join.html" class="external-link">bbr::nm_join()</a></code> on each
chain submodel and then combines the results, summarizing the table values
across chains.</p>
<p>By default <code>nm_join_bayes()</code> replaces some table quantities with summaries of
<strong>simulated</strong> values. It selects a subset of posterior samples and simulates
EPRED and IPRED with specified <span class="pkg">mrgsolve</span> model. It also feeds the
simulated EPRED values to <span class="pkg">npde</span> to calculate EWRES and NPDE values.</p>
<p><code>nm_join_bayes_quick()</code>, on the other hand, avoids the simulation; the
reported values are calculated from the table values. <strong>Warning</strong>: these
estimates should not be considered as reliable but may be useful in the early
stages of model development.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">nm_join_bayes</span><span class="op">(</span></span>
<span>  <span class="va">.mod</span>,</span>
<span>  <span class="va">mod_mrgsolve</span>,</span>
<span>  .join_col <span class="op">=</span> <span class="st">"NUM"</span>,</span>
<span>  .files <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  .superset <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  dv_col <span class="op">=</span> <span class="st">"DV"</span>,</span>
<span>  y_col <span class="op">=</span> <span class="st">"Y"</span>,</span>
<span>  point_fn <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span>,</span>
<span>  probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>  resid_var <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  n_post <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  epred <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  ipred <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  ipred_path <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  ewres_npde <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  npde_decorr_method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cholesky"</span>, <span class="st">"inverse"</span>, <span class="st">"polar"</span><span class="op">)</span>,</span>
<span>  presim_fn <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  min_batch_size <span class="op">=</span> <span class="fl">200</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">nm_join_bayes_quick</span><span class="op">(</span></span>
<span>  <span class="va">.mod</span>,</span>
<span>  .join_col <span class="op">=</span> <span class="st">"NUM"</span>,</span>
<span>  .files <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  .superset <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  point_fn <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>


<dl><dt id="arg--mod">.mod<a class="anchor" aria-label="anchor" href="#arg--mod"></a></dt>
<dd><p>A <code>bbi_nmbayes_model</code> object.</p></dd>


<dt id="arg-mod-mrgsolve">mod_mrgsolve<a class="anchor" aria-label="anchor" href="#arg-mod-mrgsolve"></a></dt>
<dd><p>An mrgsolve model object, potentially updated to be
optimized for simulation from the data set and model (e.g., ODE solver
tolerance). This must capture <code>y_col</code>.</p></dd>


<dt id="arg--join-col">.join_col<a class="anchor" aria-label="anchor" href="#arg--join-col"></a></dt>
<dd><p>Use this column to join tables files to the input data.</p></dd>


<dt id="arg--files">.files<a class="anchor" aria-label="anchor" href="#arg--files"></a></dt>
<dd><p>Paths to table files to pass to <code><a href="https://metrumresearchgroup.github.io/bbr/reference/nm_join.html" class="external-link">bbr::nm_join()</a></code> calls (one per
each chain submodel). By default, all tables specified in the <code>$TABLE</code>
blocks of the control stream will be used. Note that, unlike
<code><a href="https://metrumresearchgroup.github.io/bbr/reference/nm_join.html" class="external-link">bbr::nm_join()</a></code>, this function accepts only relative paths (which
<code>nm_join()</code> interprets as relative to submodel output directory) because
the paths need to be valid for each chain submodel.</p></dd>


<dt id="arg--superset">.superset<a class="anchor" aria-label="anchor" href="#arg--superset"></a></dt>
<dd><p>If <code>FALSE</code>, the default, the data will be joined to the
NONMEM output and if <code>TRUE</code>, the NONMEM output will be joined to the data;
that is, if you use <code>.superset</code>, you will get the same number of rows as
you have in the input data and NONMEM output columns like <code>PRED</code> and
<code>CWRES</code> will be filled with <code>NA</code>.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments passed to <code><a href="https://metrumresearchgroup.github.io/bbr/reference/nm_join.html" class="external-link">bbr::nm_join()</a></code>.</p></dd>


<dt id="arg-dv-col">dv_col<a class="anchor" aria-label="anchor" href="#arg-dv-col"></a></dt>
<dd><p>Pass this data column as the dependent variable when
calculating EWRES and NPDE.</p></dd>


<dt id="arg-y-col">y_col<a class="anchor" aria-label="anchor" href="#arg-y-col"></a></dt>
<dd><p>The name of the dependent variable in <code>mod_mrgsolve</code>. This is a
simulated quantity corresponding to <code>dv_col</code>.</p></dd>


<dt id="arg-point-fn">point_fn<a class="anchor" aria-label="anchor" href="#arg-point-fn"></a></dt>
<dd><p>Function used to calculate point estimates of table values
across chains and of simulated EPRED and IPRED values (e.g., mean or
median).</p></dd>


<dt id="arg-probs">probs<a class="anchor" aria-label="anchor" href="#arg-probs"></a></dt>
<dd><p>A two-item vector of lower and upper probabilities to pass to
<code><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">stats::quantile()</a></code> to calculate the bounds of the simulated EPRED and
IPRED values.</p></dd>


<dt id="arg-resid-var">resid_var<a class="anchor" aria-label="anchor" href="#arg-resid-var"></a></dt>
<dd><p>Whether to include residual variability in simulations.</p></dd>


<dt id="arg-n-post">n_post<a class="anchor" aria-label="anchor" href="#arg-n-post"></a></dt>
<dd><p>Randomly select this number of posterior draws to use as input
to the simulation.</p></dd>


<dt id="arg-epred">epred<a class="anchor" aria-label="anchor" href="#arg-epred"></a></dt>
<dd><p>Simulate EPRED values, including the point estimate as <code>EPRED</code>
and the bounds as <code>EPRED_lo</code> and <code>EPRED_hi</code>.</p></dd>


<dt id="arg-ipred">ipred<a class="anchor" aria-label="anchor" href="#arg-ipred"></a></dt>
<dd><p>Simulate IPRED values, including the point estimate as <code>IPRED</code>
and the bounds as <code>IPRED_lo</code> and <code>IPRED_hi</code>.</p></dd>


<dt id="arg-ipred-path">ipred_path<a class="anchor" aria-label="anchor" href="#arg-ipred-path"></a></dt>
<dd><p>Write the IPRED simulation result (as comma-separated
values) to this path. This is useful if you need access to the full results
(e.g., for LOO calculations), not just the summary returned by this
function.</p></dd>


<dt id="arg-ewres-npde">ewres_npde<a class="anchor" aria-label="anchor" href="#arg-ewres-npde"></a></dt>
<dd><p>Whether to replace EWRES and NPDE values obtained from
table with ones generated with <span class="pkg">npde</span>.</p></dd>


<dt id="arg-npde-decorr-method">npde_decorr_method<a class="anchor" aria-label="anchor" href="#arg-npde-decorr-method"></a></dt>
<dd><p>Pass this value to <code>decorr.method</code> of
<code><a href="https://rdrr.io/pkg/npde/man/autonpde.html" class="external-link">npde::autonpde()</a></code>.</p></dd>


<dt id="arg-presim-fn">presim_fn<a class="anchor" aria-label="anchor" href="#arg-presim-fn"></a></dt>
<dd><p>Before simulating, apply this function to the data frame
that results from joining the input data and table values. The main purpose
of this argument is to provide a way to do any column renames that are
required for the mrgsolve simulation (e.g., renaming a column to "TIME").</p></dd>


<dt id="arg-min-batch-size">min_batch_size<a class="anchor" aria-label="anchor" href="#arg-min-batch-size"></a></dt>
<dd><p>To simulate EPRED and IPRED values, posterior samples
are split into batches and sent as items to <span class="pkg">future</span> <code>*apply</code>
functions. The number of batches is chosen so that each batch has at least
the number of samples specified by this argument.</p>
<p><strong>Note:</strong> You may be able to tune this value to get better performance for
a particular case (considering factors such as the model, targeted future
backend, and machine). However, the results across runs with the same
initial seed will differ if you change this value. To avoid the results
varying across different machines and future backends, do not dynamically
set this value based on the number of available workers.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p>A data frame. The base data frame is the result of combining the
<code><a href="https://metrumresearchgroup.github.io/bbr/reference/nm_join.html" class="external-link">bbr::nm_join()</a></code> results for each chain submodel and collapsing across
chains with <code>point_fn</code>. <code>EPRED</code>, <code>IPRED</code>, <code>EWRES</code>, and <code>NPDE</code> values are
replaced with a simulated estimate, if requested by the corresponding
argument.</p>
    </div>
    <div id="details">
    <h2>Details</h2>

<div class="section">
<h3 id="messages">Messages<a class="anchor" aria-label="anchor" href="#messages"></a></h3>


<p><code>nm_join_bayes()</code> and <code>nm_join_bayes_quick()</code> display messages from
<code><a href="https://metrumresearchgroup.github.io/bbr/reference/nm_join.html" class="external-link">bbr::nm_join()</a></code> about the data and table files being joined for the first
chain. Messages for the subsequent chains are omitted to avoid flooding the
console with identical output.</p>
<p>As with <code><a href="https://metrumresearchgroup.github.io/bbr/reference/nm_join.html" class="external-link">bbr::nm_join()</a></code>, you can suppress these messages by setting the
<code>bbr.verbose</code> option to <code>FALSE</code>.</p>
</div>

<div class="section">
<h3 id="parallel-processing">Parallel processing<a class="anchor" aria-label="anchor" href="#parallel-processing"></a></h3>


<p>To enable parallel processing for the EPRED and IPRED simulations, configure
<span class="pkg">future</span> ahead of calling this function via <code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">future::plan()</a></code>.</p>
</div>

<div class="section">
<h3 id="progress-bar">Progress bar<a class="anchor" aria-label="anchor" href="#progress-bar"></a></h3>


<p>The EPRED and IPRED simulations support displaying a progress bar via the
<span class="pkg">progressr</span> package. The simplest way to enable a progress bar is to wrap
the <code>nm_join_bayes()</code> call inside a <code><a href="https://progressr.futureverse.org/reference/with_progress.html" class="external-link">progressr::with_progress()</a></code> call.</p>
</div>

    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><code><a href="https://metrumresearchgroup.github.io/bbr/reference/nm_join.html" class="external-link">bbr::nm_join()</a></code>, <a href="bbr_nmbayes.html">bbr_nmbayes</a> for a high-level description of how
NONMEM Bayes models are structured in bbr</p></div>
    </div>

  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Seth Green, Kyle Meyer, Tim Waterhouse, Jonathan French, Kyle T Baron.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

      </footer></div>






  </body></html>

